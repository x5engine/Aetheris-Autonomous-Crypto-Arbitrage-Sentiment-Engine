rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Live feed collection (written by VPS bot via Admin SDK)
    // Read: Public (for real-time market data display)
    // Write: Only VPS bot (using Admin SDK, bypasses rules)
    match /live_feed/{docId} {
      // Allow public read for market data (both get and list)
      allow get: if true;
      allow list: if true;
      
      // Only VPS bot can write (uses Admin SDK)
      // Frontend cannot write
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // Alerts collection (written by VPS bot, updated by frontend for AI validation)
    // Read: Public
    // Write: Frontend can update (for AI validation), VPS bot creates (via Admin SDK)
    match /alerts/{alertId} {
      // Allow public read (both get and list)
      allow get: if true;
      allow list: if true;
      
      // Allow authenticated users to update alerts (for AI sentiment analysis)
      allow update: if isAuthenticated() &&
                      // Only allow updating specific fields
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                        'status',
                        'ai_validation',
                        'analyzed_at'
                      ])) &&
                      // Valid status transitions
                      (request.resource.data.status == resource.data.status ||
                       request.resource.data.status in ['ANALYZING', 'APPROVED', 'REJECTED', 'EXECUTED']);
      
      // Frontend cannot create or delete (only VPS bot creates)
      allow create: if false;
      allow delete: if false;
    }
    
    // Legacy collections (for backward compatibility, can be removed later)
    match /market_ticks/{tickId} {
      allow read: if true;
      allow write: if false;
    }
    
    match /opportunities/{opportunityId} {
      allow read: if true;
      allow update: if isAuthenticated();
      allow create: if false;
      allow delete: if false;
    }
    
    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
            // Users collection (user-specific data)
            match /users/{userId} {
              // Users can read/write their own data
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }

            // User preferences collection (auto-execute settings)
            match /user_preferences/{userId} {
              // Users can read/write their own preferences
              allow read, write: if request.auth != null && request.auth.uid == userId;
              // Bot can read all preferences (for auto-execute logic) - public read
              allow get: if true;
              allow list: if true;
            }

            // Trades collection (user trading history)
            match /trades/{tradeId} {
              // Allow read if authenticated and (userId matches OR userId doesn't exist in document)
              // For list queries, we can't check resource.data, so allow list for authenticated users
              allow get: if request.auth != null && 
                         (resource == null || 
                          !('userId' in resource.data) || 
                          resource.data.userId == request.auth.uid);
              allow list: if request.auth != null; // Allow list for authenticated users
              // Only VPS bot can create trades (via Admin SDK)
              allow create: if false;
              // Users can update their own trades (for status updates)
              allow update: if request.auth != null && 
                          (resource == null ||
                           !('userId' in resource.data) || 
                           resource.data.userId == request.auth.uid);
              allow delete: if false;
            }

            // Order books collection (public market data)
            match /order_books/{docId} {
              allow get: if true;
              allow list: if true;
              allow create: if false;
              allow update: if false;
              allow delete: if false;
            }

            // Recent trades collection (public market data)
            match /recent_trades/{docId} {
              allow get: if true;
              allow list: if true;
              allow create: if false;
              allow update: if false;
              allow delete: if false;
            }

            // Open interest collection (public market data)
            match /open_interest/{docId} {
              allow get: if true;
              allow list: if true;
              allow create: if false;
              allow update: if false;
              allow delete: if false;
            }

            // Funding rates collection (public market data)
            match /funding_rates/{docId} {
              allow get: if true;
              allow list: if true;
              allow create: if false;
              allow update: if false;
              allow delete: if false;
            }

            // Account balance collection (user-specific, but allow public read for display)
            match /account_balance/{docId} {
              allow get: if true;
              allow list: if true;
              allow create: if false;
              allow update: if false;
              allow delete: if false;
            }

            // Positions collection (user-specific)
            match /positions/{positionId} {
              // Allow read if authenticated and (userId matches OR userId doesn't exist)
              allow get: if request.auth != null && 
                         (resource == null || 
                          !('userId' in resource.data) || 
                          resource.data.userId == request.auth.uid);
              allow list: if request.auth != null; // Allow list for authenticated users
              allow create: if false;
              allow update: if request.auth != null && 
                          (resource == null ||
                           !('userId' in resource.data) || 
                           resource.data.userId == request.auth.uid);
              allow delete: if false;
            }

            // Default deny all other collections
            match /{document=**} {
              allow read, write: if false;
            }
  }
}
